<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.InsightPrep.domain.question.mapper.FeedbackMapper">
    <insert id="insertFeedback" parameterType="feedback" keyProperty="id">
        INSERT INTO answer_feedback (score, answer_id, created_at, updated_at, improvement, model_answer)
        VALUES (#{score}, #{answer.id}, NOW(), NOW(), #{improvement}, #{modelAnswer})
    </insert>

    <select id="findById" parameterType="long" resultMap="FeedbackWithAnswerResultMap">
        SELECT
            f.id               AS feedback_id,
            f.answer_id        AS feedback_answer_id,
            f.score            AS score,
            f.improvement      AS improvement,
            f.model_answer     AS model_answer,

            a.id               AS answer_id,
            a.content          AS answer_content,
            a.question_id      AS answer_question_id,

            q.id               AS question_id,
            q.content          AS question_content
        FROM answer_feedback f
                 LEFT JOIN answer a ON f.answer_id = a.id
                 LEFT JOIN question q on a.question_id = q.id
        WHERE f.answer_id = #{answerId}
    </select>

    <resultMap id="FeedbackWithAnswerResultMap" type="feedback">
        <id property="id" column="feedback_id"/>
        <result property="score" column="score"/>
        <result property="improvement" column="improvement"/>
        <result property="modelAnswer" column="model_answer"/>

        <association property="answer" javaType="com.project.InsightPrep.domain.question.entity.Answer">
            <id property="id" column="answer_id"/>
            <result property="content" column="answer_content"/>

            <association property="question" javaType="com.project.InsightPrep.domain.question.entity.Question">
                <id property="id" column="question_id"/>
                <result property="content" column="question_content"/>
            </association>
        </association>
    </resultMap>

</mapper>